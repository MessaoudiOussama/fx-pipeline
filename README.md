# FX Rate Ingestion Pipeline

An ETL pipeline that ingests daily foreign-exchange (FX) rates
for 7 European currencies, computes all 42 cross-pairs via EUR triangulation,
and loads them into a star-schema data warehouse — locally via DuckDB, and on
Azure via ADLS Gen2 + Synapse Analytics.

---

## Currencies

`NOK` `EUR` `SEK` `PLN` `RON` `DKK` `CZK`

All directed cross-pairs are computed: **7 × 6 = 42 pairs per trading day**.

---

## Architecture

```mermaid
graph LR
    subgraph Local Architecture
        API[Frankfurter API] -->|HTTP Call| E[extract.py]
        E -->|EUR Triangulation| T[transform.py]
        T -->|DuckDB Star Schema| L[load.py]
    end

graph TD
    subgraph Azure Cloud Architecture
        TR[ADF Trigger <br/> Mon–Fri 10:00 UTC] --> P[ADF Pipeline <br/> Monitoring, Retries, Alerts]
        P -->|Triggers| F[Azure Function <br/> load_azure.py]
        KV[(Azure Key Vault <br/> Stores Secrets)] -.->|Injects via env| F
        F -->|Writes to| ADLS[ADLS Gen2 <br/> Parquet, Hive-partitioned]
        ADLS -->|Queried by| SYN[Synapse Serverless <br/> SQL queries]
    end

```

---

## Data Source

**[Frankfurter API](https://frankfurter.dev/)** — free, no API key required,
backed by the European Central Bank (ECB). Publishes one official reference rate
per currency per business day. Weekends and ECB public holidays are automatically
excluded.

**API call:**

```
GET https://api.frankfurter.dev/v1/{start}..{end}?base=EUR&symbols=NOK,SEK,PLN,RON,DKK,CZK
```

**EUR Triangulation:** The API returns rates relative to EUR only. All 42
cross-pairs are derived from a single API call using the formula:

```
rate(A → B) = rate(EUR → B) / rate(EUR → A)
```

This avoids 7 separate API calls and produces mathematically consistent results.

---

## Project Structure

```
fx_pipeline/
├── .github/
│   └── workflows/
│       └── ci_cd.yml                ← GitHub Actions: lint + test + deploy
├── etl/
│   ├── extract.py                   ← Fetches rates from Frankfurter API
│   ├── transform.py                 ← Computes 42 cross-pairs via EUR triangulation
│   ├── load.py                      ← Writes star schema to DuckDB (local)
│   └── load_azure.py                ← Writes Parquet to ADLS Gen2 (cloud)
├── orchestration/
│   ├── adf_pipeline.json            ← ADF pipeline definition
│   └── adf_trigger.json             ← ADF schedule trigger (Mon–Fri 10:00 UTC)
├── queries/
│   └── example_queries.sql          ← Reference SQL: lookups, YTD average, YTD % change
├── synapse/
│   └── setup.sql                    ← One-time Synapse Serverless setup script
├── tests/
│   ├── conftest.py                  ← Shared fixtures (no API calls)
│   ├── test_extract.py              ← API contract tests (mocked)
│   ├── test_transform.py            ← Cross-pair logic tests
│   └── test_load.py                 ← DuckDB load + idempotency tests
├── config.py                        ← Central configuration (currencies, dates, paths)
├── pipeline.py                      ← Entry point: Extract → Transform → Load
├── function_app.py                  ← Azure Function HTTP trigger (called by ADF)
├── host.json                        ← Azure Functions runtime config
├── validate.py                      ← Manual validation queries against DuckDB
├── requirements.txt                 ← Pip-compatible dependencies (generated by uv)
├── DESIGN_NOTE.md                   ← Architectural decisions and trade-offs
└── README.md
```

---

## Prerequisites

- Python 3.11+
- [uv](https://docs.astral.sh/uv/) (modern Python package manager)

---

## Quickstart

### 1. Install dependencies

```bash
uv sync
```

### 2. Run the pipeline (defaults to Jan 1 of current year → today)

```bash
uv run python pipeline.py
```

### 3. Run for a custom date range

```bash
uv run python pipeline.py --start-date 2025-01-01 --end-date 2025-12-31
```

### 4. Run tests

```bash
uv run pytest tests/ -v
```

### 5. Validate the output

```bash
uv run python -X utf8 validate.py
```

---

## How to Validate Outputs

`validate.py` runs 5 queries against `fx_warehouse.duckdb` and prints results:

| Query | What it checks                             |
| ----- | ------------------------------------------ |
| Q1    | Rate for a specific date and currency pair |
| Q2    | All 42 cross-pairs for a given date        |
| Q3    | Latest available rates for EUR             |
| Q4    | YTD average rate (Jan 1 → latest date)     |
| Q5    | YTD % change (first trading day → latest)  |

Expected row counts after a full YTD run:

- `dim_currency` → 7 rows
- `dim_date` → ~N trading days (weekends and ECB holidays excluded)
- `fact_fx_rates` → N × 42 rows

---

## YTD Definition

**Year-to-Date** is defined as the period from the **first ECB trading day of the
current calendar year** to the **latest available date in the warehouse**.

Two YTD metrics are provided:

- `ytd_avg_rate` — average of all daily closing rates in the YTD window
- `ytd_change_pct` — percentage change from the first rate of the year to the last

---

## CI/CD

Every push to `main` triggers the GitHub Actions workflow:

```
git push
    │
    ├─ ruff lint
    ├─ pytest (16 tests)
    └─ if all pass → func azure functionapp publish (auto-deploy)
```

Deployment requires the `AZURE_CREDENTIALS` secret (Service Principal JSON)
to be set in the repository's GitHub Actions secrets.

---

## Azure Deployment

See `synapse/setup.sql` for the one-time Synapse Serverless setup.
See `DESIGN_NOTE.md` for full architecture rationale and trade-offs.
